<script>
  const API_BASE = "https://inidan-finder-production.up.railway.app";

  let MEDIA_ITEMS = [];
  let lastIndex = -1;
  let mediaLoaded = false;

  const showFailBtn = document.getElementById("showFailBtn");
  const mediaShell = document.getElementById("mediaShell") || document.getElementById("videoShell");
  const placeholder = document.getElementById("placeholder");
  const videoTitleEl = document.getElementById("videoTitle");
  const videoIndexEl = document.getElementById("videoIndex");
  const videoTotalEl = document.getElementById("videoTotal");
  const toastEl = document.getElementById("toast");

  async function loadMedia() {
    try {
      const res = await fetch(`${API_BASE}/api/media`, {
        headers: { "Cache-Control": "no-cache" }
      });
      if (!res.ok) {
        console.error("Failed to load media:", res.status);
        return;
      }
      const data = await res.json();
      if (!Array.isArray(data)) {
        console.error("Media response is not an array");
        return;
      }
      MEDIA_ITEMS = data;
      mediaLoaded = true;
      if (videoTotalEl) videoTotalEl.textContent = MEDIA_ITEMS.length;
    } catch (err) {
      console.error("Error fetching media:", err);
    }
  }

  function getRandomIndex() {
    if (MEDIA_ITEMS.length === 0) return -1;
    if (MEDIA_ITEMS.length === 1) return 0;

    let i;
    do {
      i = Math.floor(Math.random() * MEDIA_ITEMS.length);
    } while (i === lastIndex);

    return i;
  }

  function clearPlaceholder() {
    if (placeholder && placeholder.parentNode) {
      placeholder.parentNode.removeChild(placeholder);
    }
  }

  function renderMedia(item) {
    clearPlaceholder();
    if (!mediaShell) return;

    mediaShell.innerHTML = "";

    const mediaType = (item.mediaType || "video").toLowerCase();
    const src = `${API_BASE}${item.src}`; // item.src is /uploads/...

    if (mediaType === "image") {
      const img = document.createElement("img");
      img.src = src;
      img.alt = item.title || "Fail meme";
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.objectFit = "contain";
      mediaShell.appendChild(img);
    } else {
      const vid = document.createElement("video");
      vid.src = src;
      vid.controls = true;
      vid.autoplay = true;
      vid.playsInline = true;
      vid.style.width = "100%";
      vid.style.height = "100%";
      mediaShell.appendChild(vid);
    }
  }

  function showToast(message) {
    if (!toastEl) return;
    toastEl.textContent = message;
    toastEl.classList.add("visible");
    clearTimeout(showToast._timeout);
    showToast._timeout = setTimeout(() => {
      toastEl.classList.remove("visible");
    }, 1800);
  }

  function handleShowFail() {
    if (!mediaLoaded) {
      alert("Still loading fails… try again in a second.");
      return;
    }
    if (!Array.isArray(MEDIA_ITEMS) || MEDIA_ITEMS.length === 0) {
      alert("No fails yet. Upload one on the submit page!");
      return;
    }

    const index = getRandomIndex();
    if (index === -1) return;
    lastIndex = index;

    const item = MEDIA_ITEMS[index];
    renderMedia(item);

    if (videoTitleEl) videoTitleEl.textContent = item.title || "Fail";
    if (videoIndexEl) videoIndexEl.textContent = index + 1;

    showToast("⚡ New fail loaded");
  }

  if (showFailBtn) {
    showFailBtn.addEventListener("click", handleShowFail);
  }

  document.addEventListener("DOMContentLoaded", loadMedia);
</script>

